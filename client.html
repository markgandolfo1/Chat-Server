<!DOCTYPE html>
<html>
   <head>
      <script src="/socket.io/socket.io.js"></script>
      <div id="one">

      </div>


      <input type="text" id="message_input" placeholder="Message"/>
      <button onclick="sendMessage()">Send</button>

      <input type="text" id="newchatname" placeholder="Group Name"/>
      <input type="text" id="password" placeholder="Password(optional)"/>

      <button onclick="createroom()">Create New Group</button>

      <input type='submit' value='Leave Room' id='leave_btn'/>

      <input type="text" id="privatemessage_input" placeholder="Nickname for Private Message (optional)"/>
      <!-- <button onclick="privatemessage()"> Send Private Message</button> -->

      <script type ="text/javascript">

// used https://www.w3schools.com/js/tryit.asp?filename=tryjs_prompt for popup below


document.getElementById("leave_btn").addEventListener("click", leaveRoom, false);


let txt;
  let person = prompt("Please enter your name:", "Nickname");
  if (person == null || person == "") {
    txt = "User cancelled the prompt.";
  } else {
    txt = "Hello " + person + "! You have joined.";
  }

document.getElementById("one").appendChild(document.createTextNode(txt));
      var socketio = io.connect();
        var currentroom = "lobby";
        var newroom = [];
        var currentnewroom = 0;

newconnect();

      socketio.on("message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         document.getElementById("chatlog").appendChild(document.createTextNode(data["user"] + ": " + data['message']));
      });

      socketio.on("message_to_client2",function(data) {
        console.log("Printing message!");
        currentroom = data['name'];
        document.getElementById("chatlog").appendChild(document.createElement("hr"));
        document.getElementById("chatlog").appendChild(document.createTextNode(data['message'] + data['name'] + " has been created. You are now in this chatroom."));
        
        
    });

    //for joining chatrooms:
    socketio.on("message_to_client3",function(data) {

        currentroom = data['name'];
        document.getElementById("chatlog").appendChild(document.createElement("hr"));
        document.getElementById("chatlog").appendChild(document.createTextNode("You have joined the chat room called: " + data['name']));
        while(document.getElementById("usersinroom").firstChild!=null){
            document.getElementById("usersinroom").removeChild(document.getElementById("usersinroom").lastChild);
        }
        let ul = document.createElement('ul');
            ul.setAttribute("id", "list");
        for(i=0; i<data["users"].length; i++){
            console.log(i);
            // document.getElementById("usersinroom").appendChild(document.createTextNode(data["users"][i]));

            //if(i==0){
            
           // }
            let li = document.createElement('li');
            li.setAttribute("id", "bullet");
            
            li.appendChild(document.createTextNode(data["users"][i]));
            ul.appendChild(li);
            //let a = document.getElementById("bullet").appendChild(document.createTextNode(data["users"][i]));
            //let b = document.getElementById("list").appendChild(a);
            
        }
        
        document.getElementById("usersinroom").appendChild(ul);

        
    });
    //to show users in lobby pass another variable thats saved before
    socketio.on("message_to_client_leavechat",function(data) {
        document.getElementById("chatlog").appendChild(document.createElement("hr"));
        document.getElementById("chatlog").appendChild(document.createTextNode("You have left the chat room called: " + data['name']));

        while(document.getElementById("usersinroom").firstChild!=null){
            document.getElementById("usersinroom").removeChild(document.getElementById("usersinroom").lastChild);
        }
        // let ul = document.createElement('ul');
        //     ul.setAttribute("id", "list");
        // for(i=0; i<data["users"].length; i++){
        //     console.log(i);
    
        //     let li = document.createElement('li');
        //     li.setAttribute("id", "bullet");
            
        //     li.appendChild(document.createTextNode(data["users"][i]));
        //     ul.appendChild(li);
        // }
        // document.getElementById("usersinroom").appendChild(ul);
        document.getElementById("usersinroom").appendChild(document.createTextNode("You are in the lobby"));

    });

    socketio.on("message_to_client_notleavechat",function(data) {
        document.getElementById("chatlog").appendChild(document.createElement("hr"));
        document.getElementById("chatlog").appendChild(document.createTextNode("Someone left"));

        while(document.getElementById("usersinroom").firstChild!=null){
            document.getElementById("usersinroom").removeChild(document.getElementById("usersinroom").lastChild);
        }
        let ul = document.createElement('ul');
            ul.setAttribute("id", "list");
            console.log("YOYOYOYOY");
        for(i=0; i<data["users"].length; i++){
            console.log(data["users"][i]);

            let li = document.createElement('li');
            li.setAttribute("id", "bullet");
            
            li.appendChild(document.createTextNode(data["users"][i]));
            ul.appendChild(li);
        }
        document.getElementById("usersinroom").appendChild(ul);

    });
   
    socketio.on("wrong", function(data) {
        alert("wrong");
    });
var btncount=0;
    socketio.on("joinroombtn",function(data) {
        let join_btn = document.createElement("button");
        console.log("BOOL" + data["bool"]);
        join_btn.setAttribute("id", data['name']);
        if(data["bool"]){
            join_btn.setAttribute("value", "pass");
        }
        else{
            join_btn.setAttribute("value", "nopass");
        }
        console.log("VAL" + join_btn.value);
        //join_btn.setAttribute("value", data['name']);
        join_btn.appendChild(document.createTextNode("Join " + data['name']));
        document.getElementById("rooms").appendChild(join_btn);
        newroom.push(data['name']);

        join_btn.addEventListener('click', joinRoom, false);
        join_btn.index = btncount;
        btncount++;
    });

    // socketio.on("addexistingroom",function(data) {




    // });

      function sendMessage(){
          console.log("current is " + currentroom);
         var msg = document.getElementById("message_input").value;

         var receiver = document.getElementById("privatemessage_input").value;
         if(receiver!=''){
            socketio.emit("privatemessage_to_server", {receiver:receiver, sender:person, name:currentroom});
         }
         //console.log("log:" + receiver);
         else{
         socketio.emit("message_to_server", {message:msg, user:person, name:currentroom});}}

         function newconnect(){
         socketio.emit("newConnection", {user:person});}

        //  function privatemessage(){
        //  var receiver = document.getElementById("privatemessage_input").value;
        //  console.log("receiver is: " + receiver);
        //  socketio.emit("privatemessage_to_server", {receiver:receiver, sender:person, name:currentroom});}


      function createroom(){
          var createroomname = document.getElementById("newchatname").value;
          console.log("New room created: " + createroomname);
          socketio.emit("newroom", {name:createroomname, creator:person, pass:document.getElementById("password").value});
      }

      function joinRoom(index){
        var guess = '';

        if(document.getElementById(newroom[index.currentTarget.index]).value=="pass"){

            // used https://www.w3schools.com/js/tryit.asp?filename=tryjs_prompt for popup below

            guess = prompt("This room is password protected", "???");
        }

        socketio.emit("joinroom", {name:newroom[index.currentTarget.index], user:person, guess:guess});
        //currentnewroom++;
    }

    function leaveRoom(){

        socketio.emit("leaveroom", {name:currentroom, user:person});
        currentroom = "lobby";
        //currentnewroom++;
    }
      

      </script>
   </head>
   <body>
      

      <div id="chatlog"></div>

      <br>
      Users in your room:
      <br>

      <div id="usersinroom"> 
            
    </div>


      <div id="rooms"> 
          <br>
Join any of these chatrooms:
<br>
      </div>

      



   </body>
</html>